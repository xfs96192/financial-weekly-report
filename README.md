# 金融周报自动生成系统

这是一个金融周报自动生成系统，用于处理和分析金融数据，并生成各种报表。该系统将原单体脚本重构为结构化的项目，提高了代码的可维护性和扩展性。

## 项目结构

```
.
├── config.py                  # 配置文件
├── data_loader.py             # 数据加载模块
├── logic                      # 业务逻辑模块
│   ├── calculations           # 计算逻辑
│   │   ├── asset_allocation.py            # 大类资产配置
│   │   ├── channel_analysis.py            # 渠道分析
│   │   ├── expiring_products.py           # 产品到期情况
│   │   ├── high_volatility_products.py    # 周净值高波动产品清单
│   │   ├── income_monitoring.py           # 中收监控
│   │   ├── manager_aum.py                 # 投资经理规模
│   │   ├── mid_revenue_analysis.py        # 投资经理中收
│   │   ├── monthly_change.py              # 周期产品规模变化
│   │   ├── new_and_upcoming.py            # 客户周期产品
│   │   ├── outsourced_investment_risk.py  # 委外投资风险
│   │   ├── product_scale.py               # 产品规模
│   │   └── specific_series_allocation.py  # 公共策略专户
│   ├── process                 # 数据处理
│   │   └── data_process.py     # 数据处理函数
│   └── utils                   # 工具函数
│       └── functions.py        # 通用工具函数
└── main.py                    # 主程序入口
```

## 功能

该系统主要实现以下功能：

1. 数据加载与预处理
2. 产品规模分析
3. 渠道分析
4. 投资经理规模分析
5. 大类资产配置分析
6. 中收监控
7. 产品到期情况分析
8. 委外投资风险分析
9. 高波动产品清单生成

## 依赖

- Python 3.6+
- pandas
- numpy
- openpyxl
- python-dateutil
- pytz
- WindPy (可选，用于获取实时数据)

## 数据文件结构

系统依赖以下输入数据文件：

- **底层数据汇总.xlsx**: 包含多个工作表，如产品信息、运作概览、持仓明细、投资经理映射等
- **历史数据/**: 存放历史周/月/年数据的文件夹，用于生成同比环比数据
- **渠道数据.xlsx**: 包含渠道相关信息
- **新发统计表.xlsx**: 新发产品统计信息

文件放置路径应在 `config.py` 中配置的 `DATA_PATH` 目录下。

## 配置说明

`config.py` 文件包含以下主要配置项：

- **DATA_PATH**: 数据文件路径
- **REPORT_DATE**: 报告日期
- **REPORT_SHEETS**: 需要生成的报表列表
- **OUTPUT_PATH**: 输出文件保存路径
- **PORTFOLIO_FILE**: 产品组合文件名
- **CHANNEL_DATA_FILE**: 渠道数据文件名
- **NEW_PRODUCT_FILE**: 新产品统计文件名
- **HISTORICAL_DATA_PATH**: 历史数据路径

每个配置项可根据实际需求修改。

## 模块处理和计算逻辑

### 数据加载 (data_loader.py)

- **功能**: 负责从Excel文件和历史数据文件夹中加载原始数据
- **主要过程**:
  - 加载底层数据汇总中的各个工作表
  - 加载历史数据用于同比/环比分析
  - 加载渠道数据和新发产品数据
  - 对数据进行初步清洗（填充空值、日期格式转换）

### 数据处理 (logic/process/data_process.py)

- **功能**: 对原始数据进行聚合、合并、转换，为报表计算提供基础数据
- **主要过程**:
  - 运作概览数据处理（产品规模、净值数据合并）
  - 持仓明细数据处理（各产品持仓数据合并）
  - 渠道数据处理（渠道数据与产品数据关联）
  - 历史数据合并与对照

### 产品规模分析 (logic/calculations/product_scale.py)

- **功能**: 计算不同维度的产品规模及其变化情况
- **输入**: 处理后的运作概览数据、历史规模数据
- **输出**: 产品规模报表，包含总规模、分类规模、规模变化情况等
- **计算逻辑**:
  - 按产品类型、风险等级、币种等维度汇总产品规模
  - 计算本周规模变化、环比变化、同比变化
  - 生成规模分布图表

### 渠道分析 (logic/calculations/channel_analysis.py)

- **功能**: 分析各个销售渠道的产品分布和规模情况
- **输入**: 处理后的渠道数据、产品数据
- **输出**: 渠道分析报表，包含各渠道规模、分布、变化等
- **计算逻辑**:
  - 按渠道汇总各产品规模
  - 计算渠道占比、规模变化
  - 分析渠道结构变化

### 投资经理规模 (logic/calculations/manager_aum.py)

- **功能**: 分析各投资经理管理的产品规模情况
- **输入**: 产品数据、投资经理映射数据
- **输出**: 投资经理规模报表，包含各经理管理规模、产品数量等
- **计算逻辑**:
  - 根据投资经理与产品的映射关系，汇总各投资经理管理的总规模
  - 统计各投资经理管理的产品数量
  - 计算规模变化情况

### 大类资产配置 (logic/calculations/asset_allocation.py)

- **功能**: 分析整体资产配置情况和各资产类别占比
- **输入**: 持仓明细数据
- **输出**: 资产配置报表，包含各资产类别占比、变化情况等
- **计算逻辑**:
  - 按资产类别（股票、债券、基金等）汇总持仓规模
  - 计算各类资产占总资产的比例
  - 分析资产配置变化趋势

### 中收监控 (logic/calculations/income_monitoring.py)

- **功能**: 监控产品的中间业务收入情况
- **输入**: 产品费率数据、规模数据
- **输出**: 中收监控报表，包含各产品预计中收、变化情况等
- **计算逻辑**:
  - 根据产品规模和管理费率计算预期中收
  - 分析中收变化情况
  - 预测年度中收

### 产品到期情况 (logic/calculations/expiring_products.py)

- **功能**: 分析近期将到期的产品情况
- **输入**: 产品基本信息（含到期日期）
- **输出**: 产品到期报表，包含近期到期产品列表、规模等
- **计算逻辑**:
  - 筛选指定时间范围内到期的产品
  - 汇总到期产品的规模
  - 分析到期产品的风险情况

### 委外投资风险 (logic/calculations/outsourced_investment_risk.py)

- **功能**: 分析委外投资产品的风险情况
- **输入**: 委外产品数据、净值数据
- **输出**: 委外风险报表，包含风险产品清单、净值波动情况等
- **计算逻辑**:
  - 筛选委外投资产品
  - 计算净值波动情况
  - 识别高风险产品

### 高波动产品清单 (logic/calculations/high_volatility_products.py)

- **功能**: 生成周净值波动较大的产品清单
- **输入**: 产品净值数据
- **输出**: 高波动产品报表，包含波动较大的产品清单、波动原因等
- **计算逻辑**:
  - 计算各产品周净值变化幅度
  - 筛选出波动超过阈值的产品
  - 分析波动原因

### 周期产品规模变化 (logic/calculations/monthly_change.py)

- **功能**: 分析月度/季度产品规模变化情况
- **输入**: 产品规模数据、历史数据
- **输出**: 周期变化报表，包含月度/季度规模变化、占比变化等
- **计算逻辑**:
  - 计算各周期（月度/季度）规模变化
  - 分析变化原因（申购/赎回/净值变化）
  - 预测未来变化趋势

### 客户周期产品 (logic/calculations/new_and_upcoming.py)

- **功能**: 分析新发和即将发行的产品情况
- **输入**: 新发产品数据、产品发行计划
- **输出**: 新发产品报表，包含新发产品列表、规模、发行计划等
- **计算逻辑**:
  - 统计新发产品数量和规模
  - 分析新发产品类型分布
  - 整理未来发行计划

### 投资经理中收 (logic/calculations/mid_revenue_analysis.py)

- **功能**: 分析各投资经理产生的中间业务收入情况
- **输入**: 投资经理映射数据、产品规模、费率数据
- **输出**: 经理中收报表，包含各经理产生的中收、变化情况等
- **计算逻辑**:
  - 按投资经理汇总其管理产品的规模
  - 结合费率计算各经理产生的中收
  - 分析中收变化情况

### 公共策略专户 (logic/calculations/specific_series_allocation.py)

- **功能**: 分析公共策略专户的资产配置和表现
- **输入**: 公共策略专户数据、持仓明细
- **输出**: 公共策略报表，包含策略表现、配置情况等
- **计算逻辑**:
  - 筛选公共策略专户
  - 分析其资产配置情况
  - 评估策略表现

## 使用方法

1. 确保安装了所有依赖
```
pip install -r requirements.txt
```

2. 在 `config.py` 中配置数据路径和其他参数

3. 运行 `main.py` 生成周报
```
python main.py
```

## 注意事项与已知限制

- **数据完整性**: 报告的准确性和完整性依赖于输入数据的完整和准确。如果缺少某些文件或文件中的某些列，对应的报表可能无法生成或计算不准确。请检查日志文件中的警告和错误信息。
- **历史数据**: 历史对比（如与上周、上月、上年同期的比较）依赖于对应历史日期的数据文件也存在于输入目录中。
- **WindPy依赖**: 此独立版本**不包含**任何需要连接Wind金融终端的功能（例如获取实时市场指数）。原始代码中依赖WindPy的部分已被移除。
- **投资经理映射**: `main.py` 中计算投资经理规模时，假设投资经理与产品的映射关系存储在 `底层数据汇总.xlsx` 文件的一个名为 `投资经理映射` 的工作表中。如果实际情况不同，请修改 `main.py` 中加载 `manager_mapping_df` 的逻辑。
- **计算逻辑**: `main.py` 中仅实现了部分核心报表的计算调用逻辑。如果您需要生成 `config.py` 中 `REPORT_SHEETS` 定义的所有报表，可能需要检查并补充 `main.py` 中缺失的计算函数调用（例如经理中收、公共策略、资产大表、中收监控等）。
- **PDF字体**: PDF生成依赖于系统正确安装并配置了中文字体。如果PDF中文显示为乱码或方框，请检查字体配置。
- **错误处理**: 脚本包含基本的错误处理，会尝试在部分数据缺失或计算出错时继续执行，并将错误信息记录到日志中。但严重的错误（如核心数据加载失败）可能会导致脚本终止。

## 故障排除指南

常见问题及解决方法：

1. **文件路径错误**
   - 确保 `config.py` 中的路径配置正确
   - 确保所有必要的数据文件都存在于指定路径

2. **数据格式问题**
   - 检查输入数据表格的列名是否与代码中预期的一致
   - 确保日期格式正确（建议使用YYYY-MM-DD格式）

3. **计算错误**
   - 查看日志文件中的错误信息
   - 确保所有必要的历史数据都已提供

4. **执行中断**
   - 使用 try-except 语句排查特定模块错误
   - 减少一次处理的数据量
   
## GitHub访问

项目已发布在GitHub上，可通过以下链接访问：

[https://github.com/xfs96192/financial-weekly-report](https://github.com/xfs96192/financial-weekly-report)

## 贡献指南

欢迎对本项目进行贡献。贡献步骤：

1. Fork 本项目
2. 创建您的功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交您的修改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建一个 Pull Request

## 未来可能的改进

- 完善 `main.py` 中所有报表的计算调用逻辑
- 增加更灵活的配置选项（例如通过配置文件指定投资经理映射来源）
- 优化PDF报告的格式和样式
- 增加对更多数据源或格式的支持
- 增加数据可视化功能
- 实现自动邮件发送功能
- 开发用户友好的图形界面